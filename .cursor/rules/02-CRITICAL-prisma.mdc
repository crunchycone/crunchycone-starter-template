---
description: CRITICAL Prisma schema and migration rules - DATABASE INTEGRITY
globs: ["prisma/schema.prisma", "prisma/**/*.ts", "**/*.ts", "**/*.tsx"]
priority: 2
---

# ğŸ”´ CRITICAL: PRISMA DATABASE RULES

## âš ï¸ THESE RULES PREVENT DATABASE CORRUPTION AND DATA LOSS âš ï¸

## ğŸš¨ BEFORE ANY DATABASE WORK - CHECK THESE FIRST:

### 1. âŒ DATABASE EXISTS?
```bash
# Check if database file exists
ls prisma/db/prod.db
# If not found, RUN IMMEDIATELY:
npm run db:reset --yes
```

### 2. âŒ GETTING TYPE ERRORS?
```bash
# If TypeScript shows Prisma errors, RUN:
npx prisma generate
```

## ğŸ”´ CRITICAL: SCHEMA CHANGE WORKFLOW

### âš ï¸ When `prisma/schema.prisma` is modified:

**âŒ NEVER DO THIS:**
```bash
# DON'T run generate alone after schema changes
npx prisma generate  # âŒ WRONG - Types update but database doesn't!
```

**âœ… ALWAYS DO THIS:**
```bash
# Create migration FIRST (includes generate automatically)
npx prisma migrate dev --name "describe-your-changes"  # âœ… CORRECT
```

### ğŸ¯ DECISION TREE FOR SCHEMA CHANGES:

```
Did you modify schema.prisma?
â”œâ”€ YES â†’ What type of change?
â”‚   â”œâ”€ STRUCTURAL (models/fields/relations)?
â”‚   â”‚   â””â”€ RUN: npx prisma migrate dev --name "description"
â”‚   â””â”€ NON-STRUCTURAL (comments/formatting)?
â”‚       â””â”€ RUN: npx prisma generate
â””â”€ NO â†’ Continue working
```

## âš ï¸ CRITICAL WARNINGS

### ğŸš¨ SCHEMA/DATABASE MISMATCH = RUNTIME CRASHES
**FAILURE TO RUN MIGRATIONS AFTER SCHEMA CHANGES CAUSES:**
- âŒ "Column doesn't exist" errors at runtime
- âŒ "Table not found" crashes
- âŒ Data writes fail silently
- âŒ TypeScript shows fields that don't exist in database
- âŒ Production deployment failures

### ğŸš¨ RUNNING GENERATE WITHOUT MIGRATE = BROKEN STATE
**THIS CREATES A DANGEROUS MISMATCH:**
- âŒ TypeScript thinks fields exist
- âŒ Database doesn't have those fields
- âŒ Runtime crashes when accessing new fields
- âŒ Data corruption possible

## ğŸ“‹ MIGRATION NAMING CONVENTIONS

Use descriptive names that explain the change:
- âœ… `add-user-profile-table`
- âœ… `update-user-add-email-verified`
- âœ… `remove-deprecated-fields`
- âœ… `add-indexes-for-performance`
- âŒ `update` (too vague)
- âŒ `fix` (not descriptive)
- âŒ `changes` (meaningless)

## ğŸ” ERROR DETECTION & FIXES

### Common Prisma Errors and Solutions:

```
Error: "unknown column 'User.newField'"
â†’ CAUSE: Schema changed but migration not run
â†’ FIX: npx prisma migrate dev --name "add-new-field"

Error: "Table 'main.NewModel' doesn't exist"
â†’ CAUSE: Model added but migration not created
â†’ FIX: npx prisma migrate dev --name "add-new-model"

Error: "Cannot find module '.prisma/client'"
â†’ CAUSE: Prisma client not generated
â†’ FIX: npx prisma generate

Error: "Unique constraint failed"
â†’ CAUSE: Duplicate data violating unique constraint
â†’ FIX: Check your data/seed for duplicates

Error: "Foreign key constraint failed"
â†’ CAUSE: Referencing non-existent record
â†’ FIX: Ensure referenced records exist first
```

## ğŸ¯ QUICK COMMAND REFERENCE

### Essential Commands:
```bash
# After changing schema.prisma (ALWAYS USE THIS)
npx prisma migrate dev --name "your-change-description"

# Reset database completely (DELETES ALL DATA)
npm run db:reset

# View database in browser
npm run db:studio

# Generate types only (ONLY for non-structural changes)
npx prisma generate
```

## âš ï¸ CRITICAL SCHEMA CONVENTIONS

### ALWAYS Include in Every Model:
```prisma
model YourModel {
  id         String    @id @default("")  // ULID auto-generated
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?  // For soft deletes
  
  // Your fields here
}
```

### CRITICAL Import Rule:
```typescript
// âŒ NEVER import directly
import { PrismaClient } from '@prisma/client'  // âŒ WRONG

// âœ… ALWAYS import from lib
import { prisma } from '@/lib/prisma'  // âœ… CORRECT - has ULID middleware
```

## ğŸ†˜ EMERGENCY RECOVERY

### If Database is Corrupted:
```bash
# Nuclear reset - loses all data
rm -f prisma/db/prod.db
npm run db:reset --yes
```

### If Migrations are Broken:
```bash
# Reset migrations (dev only!)
rm -rf prisma/migrations
npx prisma migrate dev --name "initial"
```

### If Types Don't Match Database:
```bash
# Regenerate everything
npx prisma generate
npx prisma db push --force-reset  # Dev only!
```

## âœ… SUCCESS INDICATORS

You're doing it right when:
- âœ… No TypeScript errors about Prisma types
- âœ… `npm run dev` starts without database errors
- âœ… Can create/read/update/delete records
- âœ… Prisma Studio shows your schema correctly

## ğŸ“ CHECKLIST FOR SCHEMA CHANGES

Before committing schema changes:
- [ ] Modified `schema.prisma`
- [ ] Ran `npx prisma migrate dev --name "description"`
- [ ] Migration file created in `prisma/migrations/`
- [ ] Tested that migration works
- [ ] Committed both schema AND migration files
- [ ] No TypeScript errors

---
âš ï¸ **GOLDEN RULE**: When schema.prisma changes, ALWAYS migrate first, NEVER just generate!